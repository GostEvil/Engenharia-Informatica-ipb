/*
	client-reader.c
	Trabalho Prático 2 - Sistemas Operativos
	Autores:
		Joana Moreira a63416
		Luís Fernandes a50765
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <string.h>
#include <signal.h>
#include <errno.h>

#define MAX_MSG 256
#define SERVER_FIFO "/tmp/chat_server_fifo"

char my_fifo[50];

void stop_handler (int sig) {
	unlink(my_fifo);
	printf("\n>>>> LEITOR ENCERRADO <<<<\n");
	exit(0);
}

int main() {
	char buffer[MAX_MSG];
	pid_t my_pid = getpid();

	sprintf(my_fifo, "/tmp/chat_client_%d", my_pid);
	signal(SIGINT, stop_handler);
    
	if (mkfifo(my_fifo, 0666) == -1) {
		if (errno != EEXIST) {
			perror("!!! Erro fatal ao criar FIFO");
			exit(1);
		}
	}
	system("clear");
	printf("\n");
	printf("----------------------------------------\n");
	printf("              LEITOR ONLINE\n");
	printf("                PID: %d\n", my_pid);
	printf("----------------------------------------\n");
	printf(" >> A conectar ao servidor…\n");

	int server_fd = open(SERVER_FIFO, O_WRONLY);
	if (server_fd != -1) {
		char login_msg[MAX_MSG];
		sprintf(login_msg, "%d:>> ENTROU NO CHAT <<", my_pid);
		write(server_fd, login_msg, strlen(login_msg) + 1);
		close(server_fd);
		printf(" >> Conectado com sucesso!\n");
	} else {
		printf(" >> AVISO: Servidor parece desligado\n");
	}
	printf("\n");
	printf("A aguardar mensagens…\n");
	printf("\n");

	int fd = open(my_fifo, O_RDWR);
    
	if (fd == -1) {
		perror("!!! Erro ao abrir FIFO");
		unlink (my_fifo);
		return 1;
	}

	while (1) {
		int n = read(fd, buffer, MAX_MSG);
        
		if (n > 0) {
			buffer[n] = '\0';

			int sender_pid;
			char msg_text[MAX_MSG];

			if (sscanf(buffer, "%d:%[^\n]", &sender_pid, msg_text) == 2) {
				printf("[Cliente %d]: %s\n", sender_pid, msg_text);
			}
		}
	}

	close(fd);
	unlink(my_fifo);
	return 0;
}